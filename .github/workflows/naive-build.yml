name: Build

on:
  workflow_dispatch:
    inputs:
      release:
        description: 'Publish to go-release branch'
        type: boolean
        default: false
  push:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ github.event_name }}
  cancel-in-progress: true

jobs:
  linux:
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd64
            clang_target: x86_64-linux-gnu
            sysroot_arch: amd64
          - arch: arm64
            clang_target: aarch64-linux-gnu
            sysroot_arch: arm64
          - arch: "386"
            clang_target: i686-linux-gnu
            sysroot_arch: i386
          - arch: arm
            clang_target: arm-linux-gnueabihf
            sysroot_arch: armhf
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: 'recursive'
      - uses: actions/setup-go@v5
        with:
          go-version: ^1.22
      - name: Get naiveproxy commit
        id: naive
        run: echo "commit=$(git -C naiveproxy rev-parse HEAD)" >> $GITHUB_OUTPUT
      - name: Get Chromium version
        id: chromium
        run: echo "version=$(cat naiveproxy/CHROMIUM_VERSION)" >> $GITHUB_OUTPUT
      - name: Cache build artifacts
        id: build-cache
        uses: actions/cache@v4
        with:
          path: naiveproxy/src/out
          key: naive-build-${{ steps.naive.outputs.commit }}-${{ hashFiles('cmd/build-naive/cmd_build.go', 'cmd/build-naive/cmd.go') }}-linux-${{ matrix.arch }}
      - name: Cache ccache files
        if: steps.build-cache.outputs.cache-hit != 'true'
        uses: actions/cache@v4
        with:
          path: ~/.cache/ccache
          key: ccache-linux-${{ matrix.arch }}-${{ steps.chromium.outputs.version }}
          restore-keys: ccache-linux-${{ matrix.arch }}-
      - name: Install packages
        if: steps.build-cache.outputs.cache-hit != 'true'
        run: |
          sudo apt update
          sudo apt install -y ninja-build ccache qemu-user-binfmt
      - name: Reset ccache stats
        if: steps.build-cache.outputs.cache-hit != 'true'
        run: ccache -z
      - name: Build
        if: steps.build-cache.outputs.cache-hit != 'true'
        run: go run ./cmd/build-naive --targets=linux/${{ matrix.arch }} build
      - name: Show ccache stats
        if: steps.build-cache.outputs.cache-hit != 'true'
        run: ccache -s
      - name: Package
        run: go run ./cmd/build-naive --targets=linux/${{ matrix.arch }} package
      - name: Cache toolchain
        uses: actions/cache@v4
        with:
          path: |
            naiveproxy/src/third_party/llvm-build
            naiveproxy/src/gn/out
            naiveproxy/src/chrome/build/pgo_profiles
          key: toolchain-linux-${{ steps.chromium.outputs.version }}
      - name: Download clang and sysroot
        run: go run ./cmd/build-naive --targets=linux/${{ matrix.arch }} download-toolchain
      - name: Install QEMU for cross-platform testing
        if: matrix.arch != 'amd64'
        run: |
          sudo apt update
          sudo apt install -y qemu-user-binfmt
      - name: Get CGO flags
        id: cgo-flags
        run: |
          CGO_FLAGS=$(go run ./cmd/build-naive --targets=linux/${{ matrix.arch }} cgo-flags)
          echo "CGO_FLAGS: $CGO_FLAGS"
          echo "flags=$CGO_FLAGS" >> $GITHUB_OUTPUT
      - name: Build test binary
        run: |
          CLANG=$PWD/naiveproxy/src/third_party/llvm-build/Release+Asserts/bin/clang
          SYSROOT=$PWD/naiveproxy/src/out/sysroot-build/bullseye/bullseye_${{ matrix.sysroot_arch }}_staging
          CC="$CLANG --target=${{ matrix.clang_target }} --sysroot=$SYSROOT" \
          CXX="$CLANG++ --target=${{ matrix.clang_target }} --sysroot=$SYSROOT" \
          CGO_ENABLED=1 \
          CGO_LDFLAGS="${{ steps.cgo-flags.outputs.flags }} -fuse-ld=lld -no-pie" \
          GOOS=linux \
          GOARCH=${{ matrix.arch }} \
          go test -c -o cronet.test .
      - name: Run test binary
        run: |
          if [ "${{ matrix.arch }}" != "amd64" ] && [ "${{ matrix.arch }}" != "386" ]; then
            export QEMU_LD_PREFIX=$PWD/naiveproxy/src/out/sysroot-build/bullseye/bullseye_${{ matrix.sysroot_arch }}_staging
          fi
          ./cronet.test -test.v -test.run=TestEngineVersion
      - uses: actions/upload-artifact@v4
        with:
          name: cronet-linux-${{ matrix.arch }}
          path: |
            lib/
            include/
            include_cgo.go

  darwin:
    runs-on: macos-15
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: darwin/amd64
            name: darwin-amd64
          - target: darwin/arm64
            name: darwin-arm64
          - target: ios/arm64
            name: ios-arm64
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: 'recursive'
      - uses: actions/setup-go@v5
        with:
          go-version: ^1.22
      - name: Get naiveproxy commit
        id: naive
        run: echo "commit=$(git -C naiveproxy rev-parse HEAD)" >> $GITHUB_OUTPUT
      - name: Get Chromium version
        id: chromium
        run: echo "version=$(cat naiveproxy/CHROMIUM_VERSION)" >> $GITHUB_OUTPUT
      - name: Cache build artifacts
        id: build-cache
        uses: actions/cache@v4
        with:
          path: naiveproxy/src/out
          key: naive-build-${{ steps.naive.outputs.commit }}-${{ hashFiles('cmd/build-naive/cmd_build.go', 'cmd/build-naive/cmd.go') }}-${{ matrix.name }}
      - name: Cache ccache files
        if: steps.build-cache.outputs.cache-hit != 'true'
        uses: actions/cache@v4
        with:
          path: ~/Library/Caches/ccache
          key: ccache-darwin-${{ matrix.name }}-${{ steps.chromium.outputs.version }}
          restore-keys: ccache-darwin-${{ matrix.name }}-
      - name: Install tools
        if: steps.build-cache.outputs.cache-hit != 'true'
        run: brew install ninja ccache
      - name: Reset ccache stats
        if: steps.build-cache.outputs.cache-hit != 'true'
        run: ccache -z
      - name: Build
        if: steps.build-cache.outputs.cache-hit != 'true'
        run: go run ./cmd/build-naive --targets=${{ matrix.target }} build
      - name: Show ccache stats
        if: steps.build-cache.outputs.cache-hit != 'true'
        run: ccache -s
      - name: Package
        run: go run ./cmd/build-naive --targets=${{ matrix.target }} package
      - name: Build and run test binary
        if: matrix.target != 'ios/arm64'
        run: |
          CGO_ENABLED=1 \
          CGO_LDFLAGS="$(go run ./cmd/build-naive --targets=${{ matrix.target }} cgo-flags)" \
          GOOS=$(echo "${{ matrix.target }}" | cut -d/ -f1) \
          GOARCH=$(echo "${{ matrix.target }}" | cut -d/ -f2) \
          go test -c -o cronet.test .
          ./cronet.test -test.v -test.run=TestEngineVersion
      - uses: actions/upload-artifact@v4
        with:
          name: cronet-${{ matrix.name }}
          path: |
            lib/
            include/
            include_cgo.go

  windows:
    runs-on: windows-2022
    strategy:
      fail-fast: false
      matrix:
        arch: [amd64, arm64, "386"]
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: 'recursive'
      - uses: actions/setup-go@v5
        with:
          go-version: ^1.22
      - name: Get naiveproxy commit
        id: naive
        shell: bash
        run: echo "commit=$(git -C naiveproxy rev-parse HEAD)" >> $GITHUB_OUTPUT
      - name: Get Chromium version
        id: chromium
        shell: bash
        run: echo "version=$(cat naiveproxy/CHROMIUM_VERSION)" >> $GITHUB_OUTPUT
      - name: Cache build artifacts
        id: build-cache
        uses: actions/cache@v4
        with:
          path: naiveproxy/src/out
          key: naive-build-${{ steps.naive.outputs.commit }}-${{ hashFiles('cmd/build-naive/cmd_build.go', 'cmd/build-naive/cmd.go', 'naiveproxy/src/components/grpc_support/BUILD.gn') }}-windows-${{ matrix.arch }}
      - name: Cache sccache files
        if: steps.build-cache.outputs.cache-hit != 'true'
        uses: actions/cache@v4
        with:
          path: ~/AppData/Local/Mozilla/sccache
          key: sccache-windows-${{ matrix.arch }}-${{ steps.chromium.outputs.version }}
          restore-keys: sccache-windows-${{ matrix.arch }}-
      - name: Install tools
        if: steps.build-cache.outputs.cache-hit != 'true'
        run: |
          choco install ninja sccache
      - name: Reset sccache stats
        if: steps.build-cache.outputs.cache-hit != 'true'
        run: sccache -z
      - name: Build
        if: steps.build-cache.outputs.cache-hit != 'true'
        run: go run ./cmd/build-naive --targets=windows/${{ matrix.arch }} build
      - name: Show sccache stats
        if: steps.build-cache.outputs.cache-hit != 'true'
        run: sccache -s
      - name: Package
        run: go run ./cmd/build-naive --targets=windows/${{ matrix.arch }} package
      - name: Build and run test binary
        if: matrix.arch != 'arm64'
        shell: bash
        run: |
          # Copy DLL to current directory for fallback loading
          cp lib/windows_${{ matrix.arch }}/libcronet.dll .
          CGO_ENABLED=0 \
          GOOS=windows \
          GOARCH=${{ matrix.arch }} \
          go test -tags with_purego -c -o cronet.test.exe .
          ./cronet.test.exe -test.v -test.run=TestEngineVersion
      - uses: actions/upload-artifact@v4
        with:
          name: cronet-windows-${{ matrix.arch }}
          path: |
            lib/
            include/
            include_cgo.go

  android:
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: arm64
            ndk_triple: aarch64-linux-android
          - arch: amd64
            ndk_triple: x86_64-linux-android
          - arch: arm
            ndk_triple: armv7a-linux-androideabi
          - arch: "386"
            ndk_triple: i686-linux-android
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: 'recursive'
      - uses: actions/setup-go@v5
        with:
          go-version: ^1.22
      - name: Get naiveproxy commit
        id: naive
        run: echo "commit=$(git -C naiveproxy rev-parse HEAD)" >> $GITHUB_OUTPUT
      - name: Get Chromium version
        id: chromium
        run: echo "version=$(cat naiveproxy/CHROMIUM_VERSION)" >> $GITHUB_OUTPUT
      - name: Cache build artifacts
        id: build-cache
        uses: actions/cache@v4
        with:
          path: naiveproxy/src/out
          key: naive-build-${{ steps.naive.outputs.commit }}-${{ hashFiles('cmd/build-naive/cmd_build.go', 'cmd/build-naive/cmd.go') }}-android-${{ matrix.arch }}
      - name: Cache ccache files
        if: steps.build-cache.outputs.cache-hit != 'true'
        uses: actions/cache@v4
        with:
          path: ~/.cache/ccache
          key: ccache-android-${{ matrix.arch }}-${{ steps.chromium.outputs.version }}
          restore-keys: ccache-android-${{ matrix.arch }}-
      - name: Install packages
        if: steps.build-cache.outputs.cache-hit != 'true'
        run: |
          sudo apt update
          sudo apt install -y ninja-build ccache qemu-user-binfmt
      - name: Reset ccache stats
        if: steps.build-cache.outputs.cache-hit != 'true'
        run: ccache -z
      - name: Build
        if: steps.build-cache.outputs.cache-hit != 'true'
        run: go run ./cmd/build-naive --targets=android/${{ matrix.arch }} build
      - name: Show ccache stats
        if: steps.build-cache.outputs.cache-hit != 'true'
        run: ccache -s
      - name: Package
        run: go run ./cmd/build-naive --targets=android/${{ matrix.arch }} package
      # Skip tests for Android - running Android binaries on Linux requires Android emulator
      - uses: actions/upload-artifact@v4
        with:
          name: cronet-android-${{ matrix.arch }}
          path: |
            lib/
            include/
            include_cgo.go

  linux-musl:
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd64
            cpu: x64
            clang_target: x86_64-openwrt-linux-musl
            openwrt_arch: x86_64
          - arch: arm64
            cpu: arm64
            clang_target: aarch64-openwrt-linux-musl
            openwrt_arch: aarch64
          - arch: "386"
            cpu: x86
            clang_target: i486-openwrt-linux-musl
            openwrt_arch: i386_pentium4
          - arch: arm
            cpu: arm
            clang_target: arm-openwrt-linux-musleabi
            openwrt_arch: arm_cortex-a15_neon-vfpv4
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: 'recursive'
      - uses: actions/setup-go@v5
        with:
          go-version: ^1.22
      - name: Get naiveproxy commit
        id: naive
        run: echo "commit=$(git -C naiveproxy rev-parse HEAD)" >> $GITHUB_OUTPUT
      - name: Get Chromium version
        id: chromium
        run: echo "version=$(cat naiveproxy/CHROMIUM_VERSION)" >> $GITHUB_OUTPUT
      - name: Cache build artifacts
        id: build-cache
        uses: actions/cache@v4
        with:
          path: naiveproxy/src/out
          key: naive-build-${{ steps.naive.outputs.commit }}-${{ hashFiles('cmd/build-naive/cmd_build.go', 'cmd/build-naive/cmd.go') }}-linux-musl-${{ matrix.arch }}
      - name: Cache ccache files
        if: steps.build-cache.outputs.cache-hit != 'true'
        uses: actions/cache@v4
        with:
          path: ~/.cache/ccache
          key: ccache-linux-musl-${{ matrix.arch }}-${{ steps.chromium.outputs.version }}
          restore-keys: ccache-linux-musl-${{ matrix.arch }}-
      - name: Install packages
        if: steps.build-cache.outputs.cache-hit != 'true'
        run: |
          sudo apt update
          sudo apt install -y ninja-build zstd ccache
      - name: Reset ccache stats
        if: steps.build-cache.outputs.cache-hit != 'true'
        run: ccache -z
      - name: Build
        if: steps.build-cache.outputs.cache-hit != 'true'
        run: go run ./cmd/build-naive --targets=linux/${{ matrix.arch }} --libc=musl build
      - name: Show ccache stats
        if: steps.build-cache.outputs.cache-hit != 'true'
        run: ccache -s
      - name: Package
        run: go run ./cmd/build-naive --targets=linux/${{ matrix.arch }} --libc=musl package
      - name: Cache toolchain
        uses: actions/cache@v4
        with:
          path: |
            naiveproxy/src/third_party/llvm-build
            naiveproxy/src/gn/out
            naiveproxy/src/chrome/build/pgo_profiles
          key: toolchain-linux-${{ steps.chromium.outputs.version }}
      - name: Download toolchain
        run: go run ./cmd/build-naive --targets=linux/${{ matrix.arch }} --libc=musl download-toolchain
      - name: Install QEMU for cross-platform testing
        run: |
          sudo apt update
          sudo apt install -y qemu-user-binfmt
      - name: Get CGO flags
        id: cgo-flags
        run: |
          CGO_FLAGS=$(go run ./cmd/build-naive --targets=linux/${{ matrix.arch }} --libc=musl cgo-flags)
          echo "CGO_FLAGS: $CGO_FLAGS"
          echo "flags=$CGO_FLAGS" >> $GITHUB_OUTPUT
      - name: Build test binary
        run: |
          CLANG=$PWD/naiveproxy/src/third_party/llvm-build/Release+Asserts/bin/clang
          SYSROOT=$PWD/naiveproxy/src/out/sysroot-build/openwrt/23.05.5/${{ matrix.openwrt_arch }}
          CC="$CLANG --target=${{ matrix.clang_target }} --sysroot=$SYSROOT" \
          CXX="$CLANG++ --target=${{ matrix.clang_target }} --sysroot=$SYSROOT" \
          CGO_ENABLED=1 \
          CGO_LDFLAGS="${{ steps.cgo-flags.outputs.flags }} -fuse-ld=lld -static" \
          GOOS=linux \
          GOARCH=${{ matrix.arch }} \
          go test -c -o cronet.test -ldflags '-linkmode=external' .
      - name: Run test binary
        continue-on-error: true  # musl/QEMU test is flaky, don't block CI
        run: |
          # Static binary - can run directly with QEMU binfmt or explicit QEMU for cross-arch
          case "${{ matrix.arch }}" in
            amd64) QEMU=qemu-x86_64 ;;
            arm64) QEMU=qemu-aarch64 ;;
            386)   QEMU=qemu-i386 ;;
            arm)   QEMU=qemu-arm ;;
          esac
          timeout 60 $QEMU ./cronet.test -test.v -test.run=TestEngineVersion -test.timeout=30s
      - uses: actions/upload-artifact@v4
        with:
          name: cronet-linux-musl-${{ matrix.arch }}
          path: |
            lib/
            include/
            include_cgo.go

  publish:
    needs: [linux, linux-musl, darwin, windows, android]
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: ^1.22

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Merge artifacts
        run: |
          for dir in artifacts/cronet-*/; do
            cp -r "$dir"/* .
          done
          ls -laR lib/ include/ include_cgo.go

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Publish
        run: |
          if [ "${{ github.event.inputs.release }}" = "true" ]; then
            go run ./cmd/build-naive publish --branch go-release
          else
            go run ./cmd/build-naive publish --branch go
          fi
